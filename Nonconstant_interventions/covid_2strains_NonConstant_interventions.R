library(deSolve)

# Global variables; invariant across strains

# betas
b_1_1 <- 0.085
b_1_2 <- 0.085
b_2_1 <- 0.085
b_2_2 <- 0.085

# Recovery
w <- 0.033081

# deaths; 
m_1_1 <- 0
m_1_2 <- 0
m_2_1 <- 0
m_2_2 <- 0

# mutations
mu_1_1 <- 10^-6
mu_1_2 <- 10^-6
mu_2_1 <- 10^-6
mu_2_2 <- 10^-6

propInfected_interventions <- function(t, x, params) 
{
  with(as.list(c(params, x)),
       {
         dS_1 = w * (I_1_1_s + I_1_1_A + I_1_2_s + I_1_2_A + MD* (Q_1_1 + Q_1_2 + Is_1_1 + Is_1_2)) - (S_1/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_1_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_1_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_1 + (r_1_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_1_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_1)
         
         dI_1_1_A = pi_1_1_A * (S_1/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_1_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_1_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_1) - (mu_1_2) * I_1_1_A + pi_1_1_A * ((I_1_2_A + I_1_2_s) * mu_2_1) - m_1_1 * I_1_1_A - w * I_1_1_A - Ig*Q_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_1_A
         
         dI_1_1_s = (1 - pi_1_1_A) * (S_1/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_1_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_1_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_1) - (mu_1_2) * I_1_1_s + (1 - pi_1_1_A) * ((I_1_2_A + I_1_2_s) * mu_2_1) - m_1_1 * I_1_1_s - w * I_1_1_s - Ig*Is_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_1_s
         
         dI_1_2_A = pi_1_2_A * (S_1/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_1_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_1_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_1) - (mu_2_1) * I_1_2_A + pi_1_2_A * ((I_1_1_A + I_1_1_s) * mu_1_2) - m_1_2 * I_1_2_A - w * I_1_2_A - Ig*Q_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_2_A
         
         dI_1_2_s = (1 - pi_1_2_A) * (S_1/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_1_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_1_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_1) - (mu_2_1) * I_1_2_s + (1 - pi_1_2_A) * ((I_1_1_A + I_1_1_s) * mu_1_2) - m_1_2 * I_1_2_s - w * I_1_2_s - Ig*Is_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_2_s
         
         dS_2 = w * (I_2_1_s + I_2_1_A + I_2_2_s + I_2_2_A + MD*(Q_2_1 + Q_2_2 + Is_2_1 + Is_2_2)) - (S_2/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_2_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_2_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_2 + (r_2_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_2_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_2) 
         
         dI_2_1_A = pi_2_1_A * (S_2/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_2_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_2_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_2) - (mu_1_2) * I_2_1_A + pi_2_1_A * ((I_2_2_A + I_2_2_s) * mu_2_1) - m_2_1 * I_2_1_A - w * I_2_1_A - Q_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_1_A
         
         dI_2_1_s = (1 - pi_2_1_A) * (S_2/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_2_1 * (aT_1 * I_1_1_A + I_1_1_s) + r_2_2 * (aT_1 * I_2_1_A + I_2_1_s)) * b_1_2) - (mu_1_2) * I_2_1_s + (1 - pi_2_1_A) * ((I_2_2_A + I_2_2_s) * mu_2_1) - m_2_1 * I_2_1_s - w * I_2_1_s - Is_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_1_s
         
         dI_2_2_A = pi_2_2_A * (S_2/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_2_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_2_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_2) - (mu_2_1) * I_2_2_A + pi_2_2_A * ((I_2_1_A + I_2_1_s) * mu_1_2) - m_2_2 * I_2_2_A - w * I_2_2_A - Q_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_2_A
         
         dI_2_2_s = (1 - pi_2_2_A) * (S_2/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )) * ((r_2_1 * (aT_2 * I_1_2_A + I_1_2_s) + r_2_2 * (aT_2 * I_2_2_A + I_2_2_s)) * b_2_2) - (mu_2_1) * I_2_2_s + (1 - pi_2_2_A) * ((I_2_1_A + I_2_1_s) * mu_1_2) - m_2_2 * I_2_2_s - w * I_2_2_s - Is_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_2_s

         # Intervention functions
         dQ_1_1 = Ig*Q_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_1_A - MD*w*Q_1_1 - m_1_1 * Q_1_1 # Ignore mutation dynamics as they can't contribute to onward transmission
         dQ_1_2 = Ig*Q_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_2_A - MD*w*Q_1_2 - m_1_2 * Q_1_2
         
         dQ_2_1 = Ig*Q_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_1_A - MD*w*Q_2_1 - m_2_1 * Q_2_1
         dQ_2_2 = Ig*Q_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_2_A - MD*w*Q_2_2 - m_2_2 * Q_2_2
         
         dIs_1_1 = Ig*Is_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_1_s - MD*w*Is_1_1 - m_1_1 * Is_1_1
         dIs_1_2 = Ig*Is_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_1_2_s - MD*w*Is_1_2 - m_1_2 * Is_1_2
         
         dIs_2_1 = Ig*Is_1*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_1_s - MD*w*Is_2_1 - m_2_1 * Is_2_1
         dIs_2_2 = Ig*Is_2*(I_1_1_s + I_1_2_s +  I_2_1_s + I_2_2_s )/(S_1 + S_2 + I_1_1_A + I_1_1_s + I_1_2_A + I_1_2_s + I_2_1_A + I_2_1_s + I_2_2_A + I_2_2_s )*I_2_2_s - MD*w*Is_2_2 - m_2_2 * Is_2_2
         
         result <- c(dS_1, dI_1_1_A, dI_1_1_s, dI_1_2_A, dI_1_2_s, dS_2, dI_2_1_A, dI_2_1_s, dI_2_2_A, dI_2_2_s, dQ_1_1, dQ_1_2, dQ_2_1, dQ_2_2, dIs_1_1, dIs_1_2, dIs_2_1, dIs_2_2)
         list(result)
       }
  )
}
y <- init <- c(S_1=1e6, I_1_1_A=1, I_1_1_s=0, I_1_2_A=0, I_1_2_s=0, S_2=1e5, I_2_1_A=0, I_2_1_s=0, I_2_2_A=0, I_2_2_s=0, Q_1_1=0, Q_1_2=0, Q_2_1=0, Q_2_2=0, Is_1_1=0, Is_1_2=0, Is_2_1=0, Is_2_2=0)

